---
title: "How to?"
author: "Jiddu Alexander"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Authenticate

First get an authentication token using labguru_authenticate.

```{r}
labguru_authenticate(email    = "my@@email.com",
                     password = "mypassword",
                     server   = "https://jonathan.labguru.com",
                     set_sys  = TRUE)
```

With set_sys = TRUE your system variables LABGURU_SERVER and LABGURU_TOKEN are automatically set and can be picked up by future function calls conencting to the Labguru API. Check these variables using labguru_sys_variables()

```{r}
labguru_sys_variables()
```

# Upload data to Labguru

You can now upload a dataset to Labguru using labguru_upload_dataset. There is sample data you can load from the package.

```{r}
data("compensation")
compensation
```

```{r}
# HAS THE API FOR DATASET CHANGED ALREADY? BECAUSE IT SEEMS THIS FUNCTION BROKE.
up_0 <- labguru_upload_dataset(dataset = compensation,
                               name    = paste0("compensation", date()))
up_0
```

# List available datasets from labguru

```{r}
ld <- labguru_list_datasets()
ld
```

# Download single dataset

```{r}
df <- labguru_download_dataset(dataset_id = 1)
head(df)
```



Upload a R script

```{r}
up_1 <- labguru_upload_file(file  = "../data-raw/sample_upload_script.R", 
                            title = "My R script")
up_1
```


Upload an image

```{r}
up_2 <- labguru_upload_file(file  = "../data-raw/grazing.png", 
                            title = paste("grazing", Sys.time()))
up_2
```

Attach uploaded file to a database

```{r}
up_3 <- labguru_link_visualization(dataset_id = 61,
                                   attachment_id = up_2$id,
                                   name = "my_link")
up_3
```

Upload image with immediate link to database

```{r}
up_4 <- labguru_upload_visualization(file  = "../data-raw/grazing.png", 
                                     title = paste("grazing_again", Sys.time()),
                                     dataset_id = 61,
                                     name = "my_second_link")
up_4
```


# ic50 Analysis

## Only downloading a plate's measure, dilution and control files

Stores measure.txt, control.txt and dilution.txt in a new plate folder. If plate/ directory already exists it only runs if this directory is empty.

```{r}
labguru_download_plate(plate = 271,
                       dir = "./plate")
```

## ic50 analysis storing plate information and results locally

This function downloads the plate using plate_id and stores those results in outdir_plate. It then looks for the data files in the indir directory and performes the ic50 analysis using plates, inhib, normalize and graphics. It stores results in outdir_results directory. If img_png is true it also stores the images from the dose_response_curves pdf as single png images.

```{r}
library(ic50) # ic50 library has to be loaded otherwise you get errors with '.lastxx_measure' files

ic50 <- labguru_ic50_analysis(plate_id       = 271, 
                              indir          = ".",
                              outdir_plate   = "./plate",
                              outdir_results = "./results",
                              plates         = 2,
                              inhib          = rep(0.5,7),
                              normalize      = "mean",
                              graphics       = "single",
                              img_png        = TRUE)
ic50
```

## Upload ic50 results to Labguru

```{r}
up_5 <- labguru_ic50_upload(table       = ic50$result,
                            name        = paste0("data_", gsub("[^[:alnum:]]","", date())),
                            results_dir = ic50$dir,
                            img_pdf     = "img")
up_5
```

